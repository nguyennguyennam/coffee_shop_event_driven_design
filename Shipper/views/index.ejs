<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¦ Shipper Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <h1>ğŸšš ÄÆ¡n HÃ ng Cáº§n Giao</h1>
    <% if (orders.length === 0) { %>
    <p>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o cáº§n giao.</p>
    <% } else { %>
  <div class="orders-container">
  </div>
  <% } %>

 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io("http://localhost:3006"); // Äiá»u chá»‰nh náº¿u khÃ¡c cá»•ng

  const container = document.querySelector(".orders-container");

  // ğŸ§  Load tá»« localStorage khi má»Ÿ láº¡i trang
  const savedOrders = JSON.parse(localStorage.getItem("orders") || "[]");
  savedOrders.forEach(renderOrderCard);

  // ğŸ§© Láº¯ng nghe Ä‘Æ¡n hÃ ng má»›i tá»« socket
  socket.on("newOrder", (order) => {
    console.log("ğŸ“¦ ÄÆ¡n hÃ ng má»›i:", order);

    // ğŸ§  ThÃªm vÃ o localStorage
    const orders = JSON.parse(localStorage.getItem("orders") || "[]");
    orders.unshift(order);
    localStorage.setItem("orders", JSON.stringify(orders));

    // Hiá»ƒn thá»‹
    renderOrderCard(order);
  });

  // ğŸ§± HÃ m táº¡o tháº» HTML tá»« Ä‘Æ¡n hÃ ng
  function renderOrderCard(order) {
    const orderCard = document.createElement("div");
    orderCard.className = "order-card";
    orderCard.dataset.id = order.orderId;

    orderCard.innerHTML = `
      <div class="order-header">
        <span>ğŸ†” <strong>${order.orderId}</strong></span>
        <span class="status ${order.status.toLowerCase()}">${order.status}</span>
      </div>
      <div class="order-body">
        <p>ğŸ‘¤ KhÃ¡ch: ${order.customerId}</p>
        <p>ğŸ“… NgÃ y: ${order.orderDate}</p>
        <p>ğŸ’° GiÃ¡: <strong>${order.price}</strong></p>
        <p>ğŸ§¾ MÃ³n: 
          <ul>
            ${order.orderItems.map(item => `
              <li>${item.drinkName} (x${item.quantity})</li>
            `).join('')}
          </ul>
        </p>
        <form action="/orders/${order.orderId}/complete" method="POST" onsubmit="handleComplete(event, '${order.orderId}')">
          <button type="submit" class="complete-btn">âœ… HoÃ n táº¥t giao</button>
        </form>
      </div>
    `;

    if (container) {
      container.prepend(orderCard);
    } else {
      const newContainer = document.createElement("div");
      newContainer.className = "orders-container";
      newContainer.appendChild(orderCard);
      document.body.appendChild(newContainer);

      const noOrdersText = document.querySelector("p");
      if (noOrdersText) noOrdersText.style.display = "none";
    }
  }

  // ğŸ§¹ Khi Ä‘Æ¡n hÃ ng hoÃ n táº¥t -> xoÃ¡ khá»i UI vÃ  localStorage
  function handleComplete(event, orderId) {
    event.preventDefault();

    fetch(`/orders/${orderId}/complete`, {
      method: "POST"
    }).then(res => {
      if (res.ok) {
        // XÃ³a khá»i DOM
        const card = document.querySelector(`[data-id="${orderId}"]`);
        if (card) card.remove();

        // XÃ³a khá»i localStorage
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");
        const updated = orders.filter(o => o.orderId !== orderId);
        localStorage.setItem("orders", JSON.stringify(updated));

        console.log("âœ… ÄÃ£ giao Ä‘Æ¡n hÃ ng:", orderId);
      } else {
        alert("âŒ KhÃ´ng thá»ƒ hoÃ n táº¥t Ä‘Æ¡n hÃ ng.");
      }
    }).catch(err => {
      console.error("âŒ Lá»—i:", err);
      alert("Lá»—i máº¡ng khi hoÃ n táº¥t Ä‘Æ¡n hÃ ng.");
    });
  }
</script>

</body>
</html>
