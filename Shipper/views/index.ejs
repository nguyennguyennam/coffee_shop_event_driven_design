<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¦ Shipper Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <h1>ğŸšš ÄÆ¡n HÃ ng Cáº§n Giao</h1>
    <% if (orders.length === 0) { %>
    <p>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o cáº§n giao.</p>
    <% } else { %>
    <div class="orders-container">
        <% orders.forEach(function(order) { %>
            <div class="order-card" data-id="<%= order.orderId %>">
                <div class="order-header">
                    <span>ğŸ†” <strong><%= order.orderId %></strong></span>
                    <span class="status <%= order.status.toLowerCase() %>"><%= order.status %></span>
                </div>
                <div class="order-body">
                    <p>ğŸ‘¤ KhÃ¡ch: <%= order.customerId %></p>
                    <p>ğŸ“… NgÃ y: <%= order.orderDate %></p>
                    <p>ğŸ’° GiÃ¡: <strong><%= Math.round(order.price * 23000) %></strong> VND</p>
                    <p>ğŸ§¾ MÃ³n: 
                        <ul>
                            <% if (order.orderItems && Array.isArray(order.orderItems) && order.orderItems.length > 0) { %>
                                <% order.orderItems.forEach(function(item) { %>
                                    <li><%= item.drinkName %> (x<%= item.quantity %>)</li>
                                <% }); %>
                            <% } else { %>
                                <li>KhÃ´ng cÃ³ mÃ³n nÃ o Ä‘Æ°á»£c liá»‡t kÃª.</li>
                            <% } %>
                        </ul>
                    </p>
                    <form onsubmit="handleComplete(event, '<%= order.orderId %>')">
                        <button type="submit" class="complete-btn">âœ… HoÃ n táº¥t giao</button>
                    </form>
                </div>
            </div>
        <% }); %>
    </div>
    <% } %>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io("http://localhost:3006");

  const container = document.querySelector(".orders-container");
  const noOrdersTextElement = document.querySelector("p"); // Láº¥y tham chiáº¿u Ä‘áº¿n pháº§n tá»­ p

  // Load tá»« localStorage khi má»Ÿ láº¡i trang
  const savedOrders = JSON.parse(localStorage.getItem("orders") || "[]");
  savedOrders.forEach(order => {
      // Chá»‰ render náº¿u order chÆ°a tá»“n táº¡i trong DOM (Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p náº¿u EJS Ä‘Ã£ render)
      if (!document.querySelector(`[data-id="${order.orderId}"]`)) {
          renderOrderCard(order);
      }
  });

  // Cáº­p nháº­t tráº¡ng thÃ¡i hiá»ƒn thá»‹ cá»§a dÃ²ng "KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o" khi trang Ä‘Æ°á»£c táº£i láº§n Ä‘áº§u
  // Dá»±a trÃªn sá»‘ lÆ°á»£ng tháº» Ä‘Æ¡n hÃ ng Ä‘ang cÃ³
  if (container && container.children.length > 0) {
      if (noOrdersTextElement) {
          noOrdersTextElement.style.display = 'none';
      }
  }

  // Láº¯ng nghe Ä‘Æ¡n hÃ ng má»›i tá»« socket
  socket.on("newOrder", (order) => {
    console.log("ğŸ“¦ ÄÆ¡n hÃ ng má»›i:", order);

    let orders = JSON.parse(localStorage.getItem("orders") || "[]");
    // TrÃ¡nh thÃªm trÃ¹ng láº·p náº¿u sá»± kiá»‡n socket gá»­i láº¡i Ä‘Æ¡n hÃ ng Ä‘Ã£ cÃ³
    if (!orders.some(o => o.orderId === order.orderId)) {
        orders.unshift(order);
        localStorage.setItem("orders", JSON.stringify(orders));
        renderOrderCard(order); // Hiá»ƒn thá»‹
    } else {
        console.log(`ÄÆ¡n hÃ ng ${order.orderId} Ä‘Ã£ tá»“n táº¡i, khÃ´ng thÃªm láº¡i.`);
    }
    // Äáº£m báº£o áº©n dÃ²ng "KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o" náº¿u cÃ³ Ä‘Æ¡n hÃ ng
    if (noOrdersTextElement) {
        noOrdersTextElement.style.display = 'none';
    }
  });

  // Láº¯ng nghe sá»± kiá»‡n khi má»™t Ä‘Æ¡n hÃ ng Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  Ä‘Ã£ giao tá»« server
  socket.on("orderDeliveredUI", ({ orderId }) => {
    console.log(`ğŸ§¹ ÄÆ¡n hÃ ng ${orderId} Ä‘Ã£ Ä‘Æ°á»£c giao, xÃ³a khá»i UI.`);
    // XÃ³a khá»i DOM
    const card = document.querySelector(`[data-id="${orderId}"]`);
    if (card) {
        card.remove();
    }

    // XÃ³a khá»i localStorage
    let orders = JSON.parse(localStorage.getItem("orders") || "[]");
    const updated = orders.filter(o => o.orderId !== orderId);
    localStorage.setItem("orders", JSON.stringify(updated));

    // Kiá»ƒm tra náº¿u khÃ´ng cÃ²n Ä‘Æ¡n hÃ ng nÃ o, hiá»ƒn thá»‹ láº¡i "KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o"
    if (container && container.children.length === 0) {
        if (noOrdersTextElement) {
            noOrdersTextElement.style.display = "block";
        }
    }
  });

  // HÃ m táº¡o tháº» HTML tá»« Ä‘Æ¡n hÃ ng
  function renderOrderCard(order) {
    const orderCard = document.createElement("div");
    orderCard.className = "order-card";
    orderCard.dataset.id = order.orderId;

    // Kiá»ƒm tra an toÃ n cho order.orderItems trÆ°á»›c khi táº¡o HTML
    const itemsHtml = (order.orderItems && Array.isArray(order.orderItems) && order.orderItems.length > 0) ?
        order.orderItems.map(item => `<li>${item.drinkName} (x${item.quantity})</li>`).join('') :
        '<li>KhÃ´ng cÃ³ mÃ³n nÃ o Ä‘Æ°á»£c liá»‡t kÃª.</li>';

    orderCard.innerHTML = `
      <div class="order-header">
        <span>ğŸ†” <strong>${order.orderId}</strong></span>
        <span class="status ${order.status ? order.status.toLowerCase() : ''}">${order.status || 'Unknown'}</span>
      </div>
      <div class="order-body">
        <p>ğŸ‘¤ KhÃ¡ch: ${order.customerId}</p>
        <p>ğŸ“… NgÃ y: ${order.orderDate}</p>
        <p>ğŸ’° GiÃ¡: <strong>${order.price}</strong></p>
        <p>ğŸ§¾ MÃ³n: 
          <ul>
            ${itemsHtml}
          </ul>
        </p>
        <form onsubmit="handleComplete(event, '${order.orderId}')">
          <button type="submit" class="complete-btn">âœ… HoÃ n táº¥t giao</button>
        </form>
      </div>
    `;

    if (container) {
      container.prepend(orderCard);
      // Náº¿u ban Ä‘áº§u khÃ´ng cÃ³ Ä‘Æ¡n hÃ ng, hÃ£y áº©n p "KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o"
      if (noOrdersTextElement) {
        noOrdersTextElement.style.display = 'none';
      }
    } else {
      // TrÆ°á»ng há»£p hiáº¿m khi container chÆ°a tá»“n táº¡i
      // NÃªn Ä‘áº£m báº£o div.orders-container luÃ´n cÃ³ sáºµn trong HTML ban Ä‘áº§u
      const newContainer = document.createElement("div");
      newContainer.className = "orders-container";
      newContainer.appendChild(orderCard);
      document.body.appendChild(newContainer);

      if (noOrdersTextElement) {
        noOrdersTextElement.style.display = "none";
      }
    }
  }

  // Khi Ä‘Æ¡n hÃ ng hoÃ n táº¥t -> xoÃ¡ khá»i UI vÃ  localStorage
  function handleComplete(event, orderId) {
    event.preventDefault();

    fetch(`/orders/${orderId}/complete`, {
      method: "POST"
    }).then(res => {
      if (res.ok) {
        // XÃ³a khá»i DOM
        const card = document.querySelector(`[data-id="${orderId}"]`);
        if (card) card.remove();

        // XÃ³a khá»i localStorage
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");
        const updated = orders.filter(o => o.orderId !== orderId);
        localStorage.setItem("orders", JSON.stringify(updated));

        // Náº¿u khÃ´ng cÃ²n Ä‘Æ¡n hÃ ng nÃ o trong container, hiá»ƒn thá»‹ láº¡i dÃ²ng "KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o"
        if (container && container.children.length === 0) {
            if (noOrdersTextElement) {
                noOrdersTextElement.style.display = "block";
            }
        }

        console.log("âœ… ÄÃ£ giao Ä‘Æ¡n hÃ ng:", orderId);
      } else {
        alert("âŒ KhÃ´ng thá»ƒ hoÃ n táº¥t Ä‘Æ¡n hÃ ng.");
      }
    }).catch(err => {
      console.error("âŒ Lá»—i:", err);
      alert("Lá»—i máº¡ng khi hoÃ n táº¥t Ä‘Æ¡n hÃ ng.");
    });
  }
</script>

</body>
</html>